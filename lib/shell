${SUDO} apt update
${SUDO} apt install lsb-release

### backports ###
grep -e "^deb.*backports" /etc/apt/sources.list >/dev/null || \
  printf "\ndeb http://deb.debian.org/debian ${debian_release}-backports main contrib non-free\n" \
    | ${SUDO} tee -a /etc/apt/sources.list
printf "Package: *\nPin: release a=${debian_release}-backports\nPin-Priority: 500\n" \
    | ${SUDO} tee /etc/apt/preferences.d/backports

${SUDO} apt update
${SUDO} apt full-upgrade
### required by php-mysql-nginx ###
${SUDO} apt install apt-transport-https ca-certificates curl wget software-properties-common dirmngr gnupg2 debian-archive-keyring sudo rsync
### extras ###
${SUDO} apt install zstd unzip ncdu htop mmv git ncal shellcheck nmon

### bash setup ###
printf "EDITOR=micro\nVISUAL=micro\n" | ${SUDO} tee -a /etc/environment
[ "$is_wsl" = true ] && ${SUDO} cp $setup_dir/root/etc/wsl.conf /etc/

if [ ! -f /etc/sudoers.d/admin_successful_file ]; then
    ${SUDO} cp -rbv $setup_dir/root/etc/sudoers.d/* /etc/sudoers.d/
    rm $HOME/.sudo_as_admin_successful
fi

cat $setup_dir/root/user/.config/bash/prompt | sed 's/34/35/g' | ${SUDO} tee -a /root/.bashrc
if [ "$(id -u)" -ne 0 ]; then
    # cp -rTv $setup_dir/root/user $HOME
    cp -rv $setup_dir/root/user/. $HOME
    chmod -R u=rwX,og= $HOME/.ssh
    printf "\n# . ~/.config/bash/prompt\n" | tee -a $HOME/.bashrc
    printf ". ~/.config/bash/utils_env\n" | tee -a $HOME/.bashrc
    grep -q -e 'fastfetch' ~/.bashrc ||
        printf "\nif [ -f /usr/bin/fastfetch ]; then fastfetch; fi\\n" | tee -a ~/.bashrc
    cd $HOME
    ln -s .config/bash/aliases .bash_aliases
    # printf "Defaults:${USER} timestamp_timeout=90\n" | ${SUDO} tee -a /etc/sudoers
    # printf "Defaults:${USER} env_keep += \"EDITOR VISUAL MANPAGER\"\n" | ${SUDO} tee -a /etc/sudoers
    [ "$is_wsl" = true ] && printf "${USER} ALL=(ALL) NOPASSWD:/usr/sbin/service\n" | ${SUDO} tee -a /etc/sudoers
fi

## remove unnecessary paths ##
sudo sed -i 's#:/bin:/usr/local/games:/usr/games##' /etc/profile

printf "\nInstalling utils...\n"
$HOME/.local/bin/get-utils

# increasse sudo timout for user
tee <<EOF | ${SUDO} tee /etc/sudoers.d/${USER}
Defaults:${USER} timestamp_timeout=120
Defaults:${USER} env_keep += "EDITOR VISUAL MANPAGER"
EOF

# setup starship prompt
. $setup_dir/lib/starship


${SUDO} dpkg-reconfigure console-setup
