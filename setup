#!/bin/bash
# set -x

echo
echo '               Debian Web Server Setup                     '
echo '               -----------------------                     '
echo '  This will setup basic shell environment and install php  '
echo '  MariaDB and nginx to create a web server.                '

MARIADB_VERSION='10.7'
PHP_VERSION='8.0'

if [[ $EUID -eq 0 ]]; then
    tput setaf 1;
    echo -e "\n!Running as root! User environment and utilities will not be setup."
    tput init
    echo "Launch as a user in sudo group for complete setup."
    while true
    do
        read -p "Continue as root user (y/n)? " choice
        case "$choice" in
        y|Y )   break;;
        n|N )   exit
                break;;
        * )     echo "please enter y/Y or n/N"
                ;;
        esac
    done
else
    SUDO=sudo
fi

IS_WSL=$(grep -i microsoft /proc/version)
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

echo
echo "Select / unselect options to install:"
echo '-------------------------------------'

source $SCRIPT_DIR/misc/multiselect
MENU=("Shell setup" "MariaDB ${MARIADB_VERSION}" "PHP ${PHP_VERSION}" "NginX (mainline)" )
DEFAULT_OPTIONS=("true" "true" "true" "true")
NOTHING=("false" "false" "false" "false")
multiselect OPTIONS MENU DEFAULT_OPTIONS

[[ "$OPTIONS[@]" ==  "$NOTHING[@]" ]] && echo "Nothing selected!" && exit

if [ ${OPTIONS[0]} = "true" ]; then
    echo
    echo "Configuring system (shell utils etc.)"
    source $SCRIPT_DIR/setup.d/_system
fi

if [ ${OPTIONS[1]} = "true" ]; then
    echo
    echo "Installing and configuring MariaDB ${MARIADB_VERSION}"
    read -p "Press enter to continue"
    source $SCRIPT_DIR/setup.d/_mariadb
fi

if [ ${OPTIONS[2]} = "true" ]; then
    echo
    echo "Installing and configuring PHP ${PHP_VERSION}"
    read -p "Press enter to continue"
    source $SCRIPT_DIR/setup.d/_php
fi

if [ ${OPTIONS[3]} = "true" ]; then
    echo
    echo "Installing and configuring latest NginX"
    read -p "Press enter to continue"
    source $SCRIPT_DIR/setup.d/_nginx
fi

echo
echo "Restarting services ..."
[ ${OPTIONS[1]} = true ] && ${SUDO} systemctl restart mariadb
[ ${OPTIONS[2]} = true ] && ${SUDO} systemctl restart php${PHP_VERSION}-fpm
[ ${OPTIONS[3]} = true ] && ${SUDO} systemctl restart nginx

echo
echo 'Setup completed!'
echo '----------------------------------------------------------------'
echo 'reload ~/.profile to refresh shell.'
echo 'run zsh to laucnch zsh shell or chsh to switch to zsh.'
echo 'run setup_mailhog to install a mail catcher'
echo 'run setup_sama to install samba'
echo 'run setup_lego to install letsencrypt client'
echo
echo 'Consider adding mysql superuser for web based administration:'
echo "sudo mysql -e \"CREATE USER ${USER}@'%' IDENTIFIED VIA \\" 
echo "mysql_native_password AS PASSWORD('password') OR unix_socket; \\"
echo "GRANT ALL PRIVILEGES ON *.* TO $USER@'%' WITH GRANT OPTION;\""
echo '----------------------------------------------------------------'
echo