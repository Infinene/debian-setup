#!/bin/sh
# set -x

if [ "$(whoami)" != "root" ]; then
	SUDO=sudo
fi

if [ ! -d /opt/certbot ]; then
	${SUDO} apt update
	${SUDO} apt install python3 python3-venv libaugeas0
	${SUDO} python3 -m venv /opt/certbot/
	${SUDO} /opt/certbot/bin/pip install --upgrade pip
	${SUDO} /opt/certbot/bin/pip install certbot
	${SUDO} ln -s /opt/certbot/bin/certbot /usr/bin/certbot
	${SUDO} /opt/certbot/bin/pip install certbot-dns-linode
	${SUDO} /opt/certbot/bin/pip install certbot-dns-porkbun
	${SUDO} /opt/certbot/bin/pip install certbot-dns-godaddy
else
	# upgrade if already installed
	${SUDO} /opt/certbot/bin/pip install --upgrade certbot certbot-dns-linode certbot-dns-porkbun certbot-dns-godaddy
fi


### setup auto renewal ###
read -p  "Install auto-renewalt? [y/N] " renewal
if [ ${renewal,,} = 'y' ]; then
	echo "Installing auto renewal to run every week on Sunday..."
	echo "5 0 * * 0 root /opt/certbot/bin/pip install --upgrade certbot certbot-dns-linode certbot-dns-porkbun certbot-dns-godaddy" | ${SUDO} tee -a /etc/crontab > /dev/null
	echo "30 0 * * 0 root /opt/certbot/bin/python -c 'import random; import time; time.sleep(random.random() * 3600)' && sudo certbot renew -q" | ${SUDO} tee -a /etc/crontab > /dev/null
else
	echo "Certificates will not renew automatically."
fi
